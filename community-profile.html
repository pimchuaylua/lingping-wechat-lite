<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>My Profile | Lingping Club</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Styles -->
    <link rel="stylesheet" href="assets/mainpage_style.css" />
    <link rel="stylesheet" href="assets/community-profile_style.css">
    <!-- Config -->
    <script src="config.js"></script>

    <!-- Profile Logic -->
    <script src="js/profile-questions.js" defer></script>
    <script src="js/community-profile.js" defer></script>
</head>

<body>
    <div id="loginBlocker" style="
    position: fixed;
    inset: 0;
    background: linear-gradient(
        rgba(255,255,255,0.85),
        rgba(255,255,255,0.95)
    );
    backdrop-filter: blur(6px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
">
        <div style="
        background: white;
        padding: 28px 32px;
        border-radius: 14px;
        max-width: 360px;
        width: 90%;
        text-align: center;
        box-shadow:
            0 10px 30px rgba(0,0,0,0.08),
            0 2px 8px rgba(0,0,0,0.05);
    ">
            <div style="font-size:28px; margin-bottom:12px;">ðŸ‘‹</div>

            <h3 style="
            margin: 0 0 8px;
            font-size: 20px;
            font-weight: 600;
        ">
                Log in required
            </h3>

            <p style="
            margin: 0 0 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        ">
                Please log in to view and edit your profile.
            </p>

            <button class="primary-btn" onclick="loginAndUpdateUI()" style="
                width: 100%;
                padding: 10px 14px;
                font-size: 15px;
                border-radius: 8px;
            ">
                Log in
            </button>
        </div>
    </div>



    <div class="container">
        <div class="header">Lingping Club | Online</div>

        <div class="sub">
            A community of curious minds exploring the world through languages, cultures, and shared perspectives.
        </div>

        <!-- ðŸ‘‹ Login / User Welcome (ADDED) -->
        <div id="userWelcome" class="user-welcome"></div>

        <nav class="tab-bar">
            <a href="index.html" class="tab">Home</a>
            <a href="my-bookings.html" class="tab">Bookings</a>
            <a href="community.html" class="tab">Community</a>
            <a href="community-profile.html" class="tab active">My Profile</a>
        </nav>

        <form id="profileForm" class="card">

            <div class="event-info">

                <!-- Avatar Upload -->
                <div class="avatar-wrapper">
                    <div id="avatar" class="avatar">
                        <span id="avatarPlaceholder">Upload Photo</span>
                    </div>
                    <input type="file" id="avatarInput" accept="image/*" hidden />
                </div>

                <label class="form-label">
                    Display Name
                    <input type="text" id="displayName" placeholder="Your name" />
                </label>

                <label class="form-label">
                    Short Bio
                    <textarea id="bio" rows="2" placeholder="A short introduction..."></textarea>
                </label>

                <label class="form-label">
                    Description
                    <textarea id="description" rows="4" placeholder="Tell others more about you..."></textarea>
                </label>

                <label class="form-label">
                    Topics of Interest (comma-separated IDs)
                    <input type="text" id="topics" placeholder="topicId1, topicId2" />
                </label>

                <h3 style="margin:32px 0 16px;">More About Me</h3>

                <!-- Questions injected by JS -->
                <div id="funPrompts"></div>

                <button type="submit" class="primary-btn">
                    Save Profile
                </button>

            </div>
        </form>
    </div>

    <script>


        /* ---------------- CONFIG ---------------- */
        const { BASE_URL, API_KEY } = window.CONFIG;

        /* ---------------- LOGIN BAR ---------------- */

        function renderUserWelcome() {
            const username = localStorage.getItem("username");
            const el = document.getElementById("userWelcome");
            if (!el) return;

            if (username) {
                el.innerHTML = `
                    ðŸ‘‹ Hello <strong>${username}</strong>!
                    <span class="logout" onclick="logout()">Logout</span>
                `;
            } else {
                el.innerHTML = `
                    <button class="login-btn" onclick="loginAndUpdateUI()">Log in here</button>
                `;
            }
        }

        async function loginAndUpdateUI() {
            let userId = localStorage.getItem("userId");

            try {
                if (!userId) {
                    const username = prompt("Enter your username:");
                    if (!username) return;

                    const res = await fetch(`${BASE_URL}/auth/login`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-API-KEY": API_KEY
                        },
                        body: JSON.stringify({
                            username,
                            password: "lingpingreading33"
                        })
                    });

                    const json = await res.json();
                    userId = json?.data?.userId;

                    if (!res.ok || !userId) {
                        throw new Error("Login failed");
                    }

                    localStorage.setItem("userId", userId);
                    localStorage.setItem("username", username);
                }

                renderUserWelcome();
                USER_ID = localStorage.getItem("userId");
                document.getElementById("loginBlocker").style.display = "none";
                loadProfile();

            } catch (err) {
                alert(err.message);
            }
        }

        function logout() {
            localStorage.removeItem("userId");
            localStorage.removeItem("username");
            location.reload();
        }

        renderUserWelcome();

        /* ---------------- AVATAR UPLOAD ---------------- */

        const avatar = document.getElementById("avatar");
        const avatarInput = document.getElementById("avatarInput");
        const avatarPlaceholder = document.getElementById("avatarPlaceholder");

        function renderAvatar(photoUrl) {
            if (photoUrl) {
                avatar.style.backgroundImage = `url(${photoUrl})`;
                avatar.classList.add("has-photo");
                avatarPlaceholder.style.display = "none";
            } else {
                avatar.style.backgroundImage = "";
                avatar.classList.remove("has-photo");
                avatarPlaceholder.style.display = "block";
            }
        }

        // click avatar â†’ open file picker
        avatar.addEventListener("click", () => {
            if (!USER_ID) {
                alert("Please log in first.");
                return;
            }
            avatarInput.click();
        });

        // file selected â†’ upload
        avatarInput.addEventListener("change", async () => {
            const file = avatarInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch(
                    `${API_BASE}/users/${USER_ID}/profile/photo`,
                    {
                        method: "POST",
                        headers: {
                            "X-API-KEY": window.CONFIG.API_KEY,
                        },
                        body: formData,
                    }
                );

                if (!res.ok) {
                    throw new Error("Upload failed");
                }

                const json = await res.json();

                // backend should return updated profile or photo url
                const photoUrl =
                    json?.data?.profilePic ||
                    json?.data?.photoUrl;

                renderAvatar(photoUrl);

                alert("Photo uploaded successfully!");

            } catch (err) {
                alert(err.message);
            } finally {
                avatarInput.value = "";
            }
        });

    </script>

</body>

</html>