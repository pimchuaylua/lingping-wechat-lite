<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Lingping Club</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <!-- Styles -->
    <link rel="stylesheet" href="assets/mainpage_style.css">

    <!-- Config & Booking -->
    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/booking.js"></script>
    <script src="js/utils.js?v=20260113"></script>
</head>

<body>
    <div class="container">
        <div class="header">Lingping Club | Online</div>

        <div class="sub">
            A community of curious minds exploring the world through languages, cultures, and shared perspectives.
        </div>

        <!-- ðŸ‘‹ User Welcome -->
        <div id="userWelcome" class="user-welcome"></div>

        <nav>
            <a href="index.html">Home</a>
            <a href="my-bookings.html">My Bookings</a>
            <a href="about.html">About Us</a>
            <a href="membership.html">Join Us</a>
            <a href="contact.html">Contact Us</a>
        </nav>

        <!-- ðŸ”¹ Location Toggle -->
        <div class="location-toggle">
            <button class="location-btn active" data-level="695c763e2d652e065db71030">
                Online
            </button>
            <button class="location-btn" data-level="67eab5b337cd4b56a080743f">
                Chiang Mai
            </button>
        </div>


        <!-- ðŸ”¹ Topics -->
        <div class="topics">
            <div class="topic active" data-topic="">All</div>
            <div class="topic" data-topic="english">English Corner</div>
            <div class="topic" data-topic="thai">Thai</div>
            <div class="topic" data-topic="chinese">Chinese</div>
            <div class="topic" data-topic="book">Book Club</div>
            <div class="topic" data-topic="movie">Movie</div>
        </div>

        <!-- ðŸ”¹ Date Filter -->
        <div class="date-filter" id="dateFilter"></div>

        <!-- ðŸ”¹ Events -->
        <div id="eventList"></div>
    </div>

    <script>
        const { BASE_URL, API_KEY } = window.CONFIG;
        let currentLevel = "695c763e2d652e065db71030"; // Online default

        /* ---------------- USER WELCOME ---------------- */

        function renderUserWelcome() {
            const username = localStorage.getItem("username");
            const el = document.getElementById("userWelcome");
            if (!el) return;

            if (username) {
                el.innerHTML = `
            ðŸ‘‹ Hello <strong>${username}</strong>!
            <span class="logout" onclick="logout()">Logout</span>
        `;
            } else {
                el.innerHTML = `
            <button class="login-btn" onclick="loginAndUpdateUI()">Log in here</button>
        `;
            }
        }

        async function loginAndUpdateUI() {
            let userId = localStorage.getItem("userId");

            try {
                if (!userId) {
                    const username = prompt("Enter your username:");
                    if (!username) return;

                    const loginRes = await fetch(`${BASE_URL}/auth/login`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-API-KEY": API_KEY
                        },
                        body: JSON.stringify({
                            username,
                            password: "lingpingreading33"
                        })
                    });

                    const loginData = await loginRes.json();
                    userId = loginData?.data?.userId;

                    if (!loginRes.ok || !userId) {
                        throw new Error("Invalid username. Please check and try again.");
                    }

                    localStorage.setItem("userId", userId);
                    localStorage.setItem("username", username);
                }

                renderUserWelcome();

            } catch (err) {
                alert(err.message);
            }
        }

        function logout() {
            localStorage.removeItem("userId");
            localStorage.removeItem("username");
            location.reload();
        }

        /* ---------------- DATE HELPERS ---------------- */

        function getNext7Days() {
            const days = [];
            const today = new Date();

            for (let i = 0; i < 7; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                days.push({
                    date: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`,
                    display: d.toLocaleDateString("en-US", {
                        weekday: "short",
                        day: "numeric",
                        month: "short"
                    })
                });
            }
            return days;
        }

        const dates = getNext7Days();
        let activeDate = dates[0].date;
        let selectedTopic = "";
        let sessions = [];

        const dateFilter = document.getElementById("dateFilter");
        const eventList = document.getElementById("eventList");

        function renderDates() {
            dateFilter.innerHTML = "";

            dates.forEach(d => {
                const btn = document.createElement("div");
                btn.className = "date-btn" + (activeDate === d.date ? " active" : "");
                btn.innerText = d.display;

                btn.onclick = () => {
                    activeDate = d.date;
                    selectedTopic = "";
                    document.querySelectorAll(".topic").forEach(t => t.classList.remove("active"));
                    document.querySelector('.topic[data-topic=""]').classList.add("active");
                    renderDates();
                    renderEvents();
                };

                dateFilter.appendChild(btn);
            });
        }

        async function getReadingSessions(fromDate, toDate) {
            const params = new URLSearchParams({
                fromDate,
                toDate,
                level: currentLevel
            });

            const res = await fetch(`${BASE_URL}/reading-sessions?${params}`, {
                headers: {
                    "Content-Type": "application/json",
                    "X-API-KEY": API_KEY
                }
            });

            const json = await res.json();
            return json.data;
        }

        document.querySelectorAll(".location-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                // toggle active state
                document.querySelectorAll(".location-btn")
                    .forEach(b => b.classList.remove("active"));
                btn.classList.add("active");

                // update level
                currentLevel = btn.dataset.level;

                // re-fetch & re-render everything
                await init();
            });
        });


        function renderEvents() {
            let filtered = [...sessions];

            if (selectedTopic) {
                filtered = filtered.filter(s =>
                    s.title.toLowerCase().includes(selectedTopic)
                );
            }

            if (activeDate && !selectedTopic) {
                filtered = filtered.filter(s => s.date === activeDate);
            }

            eventList.innerHTML = "";

            if (!filtered.length) {
                eventList.innerHTML = `<div class="empty">No sessions</div>`;
                return;
            }

            filtered.forEach(s => {
                const card = document.createElement("div");
                card.className = "card";
                card.style.cursor = "pointer";

                card.innerHTML = `
                    <div class="event-info">
                        <div class="event-title">${s.title}</div>
                        <div class="event-desc">${s.description}</div>
                        <div class="event-time">${Utils.formatPrettyDate(s.date)} Â· ${s.time}</div>
                        <div class="event-time">Hosts: ${s.hosts}</div>
                    </div>
                    <div class="right">
                        <div class="status ${s.isFull ? "full" : "available"}">
                            ${s.isFull ? "Full" : `Available (${s.seatsLeft})`}
                        </div>
                        <button
                            class="book-btn ${s.isFull ? "" : "available"}"
                            ${s.isFull ? "disabled" : ""}
                            onclick="event.stopPropagation(); bookSession({ sessionId: '${s.id}' })">
                            Book
                        </button>
                    </div>
                `;

                card.onclick = () => {
                    localStorage.setItem("selectedSession", JSON.stringify(s));
                    window.location.href = "event-detail.html";
                };

                eventList.appendChild(card);
            });
        }

        document.querySelectorAll(".topic").forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll(".topic").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                selectedTopic = btn.dataset.topic;
                activeDate = null;
                renderDates();
                renderEvents();
            };
        });

        async function init() {
            renderUserWelcome();
            renderDates();

            const raw = await getReadingSessions(
                dates[0].date,
                dates[dates.length - 1].date
            );

            sessions = raw.map(s => {
                const start = new Date(s.startTime);
                const end = new Date(start.getTime() + s.durationMins * 60000);
                const hosts = s.hosts?.length
                    ? s.hosts.map(h => h.name).join(", ")
                    : "TBA";

                return {
                    id: s._id,
                    date: `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, "0")}-${String(start.getDate()).padStart(2, "0")}`,
                    time: `${start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}â€“${end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}`,
                    title: s.title,
                    description: s.shortDescription,
                    fullDescription: s.fullDescription,
                    hosts,
                    isFull: s.isFull,
                    seatsLeft: s.numberOfSeatsLeft,
                    photoUrl: s.photoUrl,
                    maxParticipants: s.maxParticipants
                };
            });

            renderEvents();
        }

        init();
    </script>
</body>

</html>