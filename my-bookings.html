<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>My Bookings | Lingping Club</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <!-- Styles -->
    <link rel="stylesheet" href="assets/mainpage_style.css">

    <!-- Config & Logic -->
    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/booking.js"></script>
    <script src="js/utils.js"></script>
</head>

<body>
    <div class="container">
        <div class="header">Lingping Club | Online</div>

        <div class="sub">
            A community of curious minds exploring the world through languages, cultures, and shared perspectives.
        </div>

        <!-- ðŸ‘‹ User Welcome -->
        <div id="userWelcome" class="user-welcome"></div>

        <nav class="tab-bar">
            <a href="index.html" class="tab active">Home</a>
            <a href="my-bookings.html" class="tab">Bookings</a>
            <a href="community.html" class="tab">Community</a>
            <a href="me.html" class="tab">Me</a>
        </nav>

        <!-- ðŸ”¹ Date Filter -->
        <div class="date-filter" id="dateFilter"></div>

        <!-- ðŸ”¹ Events -->
        <div id="eventList"></div>
    </div>

    <script>
        const { BASE_URL, API_KEY } = window.CONFIG;
        const eventList = document.getElementById("eventList");

        /* ---------------- USER WELCOME ---------------- */

        function renderUserWelcome() {
            const username = localStorage.getItem("username");
            const el = document.getElementById("userWelcome");
            if (!el) return;

            if (username) {
                el.innerHTML = `
                    ðŸ‘‹ Hello <strong>${username}</strong>!
                    <span class="logout" onclick="Auth.logout()">Logout</span>
                `;
            } else {
                el.innerHTML = `
                    <button class="login-btn" onclick="loginAndLoad()">Log in</button>
                `;
            }
        }

        async function loginAndLoad() {
            try {
                const username = prompt("Enter your username:");
                if (!username) return;

                await Auth.login(username);
                renderUserWelcome();
                loadMyBookings();
            } catch (err) {
                alert(err.message);
            }
        }

        /* ---------------- LOAD BOOKINGS ---------------- */

        async function loadMyBookings() {
            const userId = localStorage.getItem("userId");

            if (!userId) {
                eventList.innerHTML = `<div class="empty">Please log in to see your bookings.</div>`;
                return;
            }

            const bookings = await getMyBookings();

            if (!bookings || !bookings.length) {
                eventList.innerHTML = `<div class="empty">You have no upcoming bookings.</div>`;
                return;
            }

            const sessions = mapBookingsToSessions(bookings);
            renderEvents(sessions);
        }

        /* ---------------- RENDER EVENTS ---------------- */

        function renderEvents(sessions) {
            eventList.innerHTML = "";

            sessions.forEach(s => {
                const card = document.createElement("div");
                card.className = "card";

                card.innerHTML = `
                    <div class="event-info">
                        <div class="event-title">${s.title}</div>
                        <div class="event-desc">${s.description}</div>
                        <div class="event-time">${Utils.formatPrettyDate(s.date)} Â· ${s.time}</div>
                        <div class="event-time">Hosts: ${s.hosts}</div>
                    </div>
                    <div class="right">
                        <div class="status booked">Booked</div>
                    </div>
                `;

                card.onclick = () => {
                    localStorage.setItem("selectedSession", JSON.stringify(s));
                    window.location.href = "event-detail.html";
                };

                eventList.appendChild(card);
            });
        }

        /* ---------------- INIT ---------------- */

        function init() {
            renderUserWelcome();
            loadMyBookings();
        }

        init();
    </script>
</body>

</html>